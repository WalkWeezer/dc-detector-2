# DC-Detector v0.2 — Архитектура

## Обзор

Система на Raspberry Pi 5: веб-интерфейс, детекция по USB-камере, GPIO-датчики, LoRa и MAVLink 2 (UART). Всё на Node.js, упаковано в Docker.

## Принципы

- **Микросервисы**: каждый функциональный блок — отдельный контейнер.
- **Единый стек**: JS/Node.js везде, где возможно.
- **События в реальном времени**: WebSocket/SSE от сервисов к веб-клиенту.
- **Гибкость**: сервисы можно отключать (например, без LoRa или без MAVLink).

## Компоненты

```
                    ┌─────────────────────────────────────────┐
                    │              WEB BROWSER                 │
                    │  (Dashboard: камера, датчики, телеметрия) │
                    └───────────────────┬─────────────────────┘
                                        │ HTTP/WS
                                        ▼
┌──────────────┐  ┌─────────────────────────────────────────────────────┐
│   LoRa       │  │                    WEB SERVICE                       │
│   Module     │  │  (Fastify, static UI, WebSocket hub, REST API)       │
└──────┬───────┘  └───────────────────┬─────────────────────────────────┘
       │ UART                         │
       ▼                              │  internal network
┌──────────────┐  ┌──────────────┐    │
│ LORA         │  │ CAMERA       │    │  Events / REST
│ SERVICE      │  │ SERVICE      │◄───┤
│ (Node.js)    │  │ (Node.js)    │    │
└──────────────┘  └──────┬───────┘    │
                         │ USB        │
                    ┌────┴────┐       │
                    │ USB Cam │       │
                    └─────────┘       │
       ┌──────────────┐  ┌────────────┴────┐  ┌──────────────┐
       │ GPIO         │  │ MAVLINK         │  │ Redis        │
       │ SERVICE      │  │ SERVICE         │  │ (optional)   │
       │ (Node.js)    │  │ (Node.js)       │  │ pub/sub      │
       └──────┬───────┘  └───────┬─────────┘  └──────────────┘
              │ GPIO             │ UART
              ▼                  ▼
       ┌─────────────┐   ┌─────────────┐
       │ Датчики     │   │ Flight      │
       │ (температура│   │ Controller  │
       │  и т.д.)    │   │ (MAVLink 2) │
       └─────────────┘   └─────────────┘
```

## Сервисы

| Сервис        | Назначение                          | Порты/устройства              | Стек              |
|---------------|-------------------------------------|-------------------------------|-------------------|
| **web**       | API, раздача статики, WebSocket     | 3000 (HTTP/WS)                | Node, Fastify     |
| **camera**    | Захват USB-камеры, детекция         | /dev/video0                   | Node, opencv/ffmpeg или вызов внешней детекции |
| **gpio**      | Чтение/запись GPIO-датчиков         | /dev/gpiochip*                | Node, rpi-gpio/gpiozero |
| **lora**      | Обмен по LoRa (UART)                | /dev/ttyUSB* или /dev/ttyAMA* | Node, serialport |
| **mavlink**   | MAVLink 2 по UART к борту           | /dev/ttyAMA0 или /dev/ttyS0   | Node, serialport, mavlink |
| **redis**     | (опционально) Pub/Sub между сервисами | 6379                        | Redis             |

## Потоки данных

1. **Камера → веб**: MJPEG/WS или кадры + метаданные детекции в Web-сервис → браузер.
2. **GPIO**: периодический опрос/события → Web-сервис (REST или Pub/Sub) → WS → браузер.
3. **LoRa**: приём/отправка пакетов → Web-сервис → отображение и при необходимости ретрансляция.
4. **MAVLink**: чтение/запись UART → парсинг MAVLink 2 → телеметрия в Web-сервис → браузер.

## Docker

- Один `docker-compose.yml` под RPi 5 (arm64).
- Для доступа к железу: `devices`, `privileged` или `group_add` по необходимости (GPIO, UART, USB).
- Общая сеть: `dc-detector-network`.
- Переменные окружения: `.env` (не коммитить секреты).

## Расширяемость

- Добавление нового типа датчика: только в **gpio** (или новый микросервис с тем же контрактом).
- Новый протокол по UART: отдельный сервис по аналогии с **mavlink**.
- Замена детекции (другая модель/библиотека): только в **camera**, API для веба не меняется.

## Распиновка и подключение (Raspberry Pi 5)

Нумерация пинов — по 40-контактному заголовку (физический пин 1–40). Логика 3.3 V; питание 5 V только для сервоприводов (при необходимости — от отдельного БП).

### LoRa32 Heltec (Heltec Automation)

Плата может подключаться к RPi двумя способами.

**Вариант A — по USB (рекомендуется)**  
Кабель USB: Heltec ↔ свободный порт USB на RPi. В системе появится устройство `/dev/ttyUSB0` (или `/dev/ttyACM0`). В `.env`: `LORA_UART_DEVICE=/dev/ttyUSB0`. Внутри Heltec к USB уже подключён UART (обычно GPIO1/3 на ESP32).

**Вариант B — по UART (если MAVLink на другом UART)**  
Используйте второй UART RPi (например `/dev/ttyS0` на пинах 27/28) или переходник USB–UART на RPi.

| Назначение | Raspberry Pi 5       | LoRa32 Heltec (V1/V2) |
|------------|------------------------|------------------------|
| RPi → Heltec (данные) | Pin 8  (GPIO14, TXD0)  | RX (GPIO 3)           |
| Heltec → RPi (данные) | Pin 10 (GPIO15, RXD0)  | TX (GPIO 1)           |
| Земля      | Pin 9  (GND)          | GND                   |
| Питание    | — (питать от своего USB или 3.3 V) | 3.3 V / VIN по даташиту |

Пересечение: **RPi TX (8) → Heltec RX (3)**, **RPi RX (10) ← Heltec TX (1)**, **GND ↔ GND**. На Heltec V3: TX = GPIO43, RX = GPIO44 (см. даташит).

---

### Два сервопривода (PWM)

Управление по шине PWM RPi 5. Один сигнал управления на каждый сервопривод; питание 5 V и GND — общие (при большом токе — от отдельного источника 5 V).

| Назначение      | Raspberry Pi 5        | Сервопривод 1   | Сервопривод 2   |
|-----------------|------------------------|-----------------|-----------------|
| Сигнал (PWM)    | Pin 12 (GPIO18, PWM0)  | Сигнал (оранж.) | —               |
| Сигнал (PWM)    | Pin 32 (GPIO12, PWM0)  | —               | Сигнал (оранж.) |
| Питание 5 V     | Pin 2 или Pin 4 (5 V)  | VCC (красн.)    | VCC (красн.)    |
| Земля           | Pin 6, 9, 14, 20, 25…  | GND (коричн.)   | GND (коричн.)   |

В коде GPIO-сервиса использовать **GPIO18** и **GPIO12** как каналы PWM для двух сервоприводов. При питании от пинов RPi учитывайте суммарный ток (лучше питать сервы от внешнего 5 V и общую GND с RPi).

---

### UART для MAVLink 2 (полётный контроллер)

Используется основной UART RPi 5 на заголовке. В системе — обычно `/dev/ttyAMA0` (или `/dev/serial0`). В `.env`: `MAVLINK_UART_DEVICE=/dev/ttyAMA0`, `MAVLINK_BAUD=57600` (или 115200 по настройкам борта).

| Назначение        | Raspberry Pi 5       | Полётный контроллер (FC) |
|-------------------|----------------------|---------------------------|
| RPi передаёт      | Pin 8  (GPIO14, TXD) | RX (приём на FC)          |
| RPi принимает     | Pin 10 (GPIO15, RXD) | TX (передача с FC)        |
| Земля             | Pin 9  (GND)         | GND                       |

Пересечение: **RPi TX (8) → FC RX**, **RPi RX (10) ← FC TX**, **GND ↔ GND**. Уровни: 3.3 V (RPi). Если на борту 5 V TTL — использовать преобразователь уровней 3.3 V ↔ 5 V.

---

### Сводка по устройствам на RPi 5

| Функция        | Устройство / пины              | Переменная / примечание        |
|----------------|--------------------------------|---------------------------------|
| LoRa           | USB или UART (см. выше)        | `LORA_UART_DEVICE`              |
| MAVLink        | Pin 8 (TX), Pin 10 (RX), Pin 9 (GND) | `MAVLINK_UART_DEVICE`, `MAVLINK_BAUD` |
| Сервопривод 1  | Pin 12 (GPIO18, PWM)           | Управление в gpio-сервисе       |
| Сервопривод 2  | Pin 32 (GPIO12, PWM)           | Управление в gpio-сервисе       |

Если LoRa32 подключён по USB, а MAVLink — по GPIO14/15, конфликта UART нет: LoRa = `/dev/ttyUSB0`, MAVLink = `/dev/ttyAMA0`.

---

## Безопасность

- Веб только во внутренней сети или за reverse proxy с TLS.
- Нет хардкода паролей; секреты из `.env`.
- Контейнеры с минимальными правами; `privileged` только там, где нужен доступ к устройствам.
