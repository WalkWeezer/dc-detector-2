<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DC-Detector v0.2</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="page">
    <main class="main-grid">

      <!-- ====== Left: Video + Status Strip ====== -->
      <div class="video-col">
        <div class="video-wrapper">
          <img id="stream" alt="Video stream" />
          <canvas id="overlay"></canvas>
        </div>

        <div class="status-strip">
          <div class="ss-item">
            <span class="ss-label">Status</span>
            <strong id="status-indicator">Connecting...</strong>
          </div>
          <div class="ss-item">
            <span class="ss-label">Tracks</span>
            <strong id="track-count">&mdash;</strong>
          </div>
          <div class="ss-item">
            <span class="ss-label">FPS</span>
            <strong id="det-fps">&mdash;</strong>
          </div>
          <div class="ss-item">
            <span class="ss-label">MAVLink</span>
            <strong id="mav-status"><span class="dot" id="mav-dot"></span> &mdash;</strong>
          </div>
          <div class="ss-item">
            <span class="ss-label">LoRa</span>
            <strong id="lora-status"><span class="dot" id="lora-dot"></span> &mdash;</strong>
          </div>
        </div>

        <p id="error-message" class="status-error"></p>
      </div>

      <!-- ====== Right: Sidebar Tabs ====== -->
      <aside class="sidebar">
        <nav class="sidebar-tabs" role="tablist">
          <button class="tab-btn active" data-tab="detection" role="tab">Detection</button>
          <button class="tab-btn" data-tab="telemetry" role="tab">Telemetry</button>
          <button class="tab-btn" data-tab="lora" role="tab">LoRa</button>
          <button class="tab-btn" data-tab="db" role="tab">DB</button>
        </nav>

        <div class="sidebar-content">

          <!-- ── Tab 1: Detection ── -->
          <div id="tab-detection" class="tab-panel active" role="tabpanel">

            <!-- Model & Config -->
            <section class="card">
              <header><h2>Model & Config</h2></header>
              <div class="form-col">
                <div class="form-row">
                  <label class="form-label">Model</label>
                  <div class="input-row">
                    <select id="model-select"></select>
                    <button id="model-switch-btn" class="sm">Switch</button>
                  </div>
                </div>
                <div class="slider-field">
                  <div class="slider-label"><span>Confidence</span><span class="slider-value" id="conf-val">0.50</span></div>
                  <input type="range" id="conf-slider" min="5" max="100" value="50" />
                </div>
                <div class="slider-field">
                  <div class="slider-label"><span>Save to DB</span><span class="slider-value" id="save-conf-val">0.50</span></div>
                  <input type="range" id="save-conf-slider" min="5" max="100" value="50" />
                </div>
                <div class="form-row">
                  <label class="form-label">Input Size</label>
                  <select id="imgsz-select">
                    <option value="160">160</option>
                    <option value="320">320</option>
                    <option value="480">480</option>
                    <option value="640" selected>640</option>
                    <option value="960">960</option>
                    <option value="1280">1280</option>
                  </select>
                </div>
                <div class="slider-field">
                  <div class="slider-label"><span>Skip Frames</span><span class="slider-value" id="skip-val">0</span></div>
                  <input type="range" id="skip-slider" min="0" max="30" value="0" />
                </div>
                <button id="apply-config-btn" class="accent full-w">Apply</button>
              </div>
            </section>

            <!-- Metrics -->
            <section class="card">
              <header><h2>Performance</h2></header>
              <div class="metrics-grid">
                <div class="metric"><span class="m-label">FPS</span><span class="m-val" id="m-fps">&mdash;</span></div>
                <div class="metric"><span class="m-label">Inference</span><span class="m-val" id="m-infer">&mdash;</span></div>
                <div class="metric"><span class="m-label">Avg ms</span><span class="m-val" id="m-avg">&mdash;</span></div>
                <div class="metric"><span class="m-label">Frame #</span><span class="m-val" id="m-frame">&mdash;</span></div>
                <div class="metric"><span class="m-label">Tracks</span><span class="m-val" id="m-tracks">&mdash;</span></div>
                <div class="metric"><span class="m-label">Total Det.</span><span class="m-val" id="m-total">&mdash;</span></div>
              </div>
            </section>

            <!-- Active Tracks -->
            <section class="card">
              <header><h2>Active Tracks</h2><span id="tracker-refresh" class="link-btn">Refresh</span></header>
              <div id="tracker-list" class="tracker-list empty-state">No active tracks</div>
            </section>
          </div>

          <!-- ── Tab 2: Telemetry ── -->
          <div id="tab-telemetry" class="tab-panel" role="tabpanel">
            <div class="tgrid">
              <div class="tcard">
                <h3>GPS</h3>
                <div class="row"><span class="lbl">Lat</span><span class="val" id="t-lat">&mdash;</span></div>
                <div class="row"><span class="lbl">Lon</span><span class="val" id="t-lon">&mdash;</span></div>
                <div class="row"><span class="lbl">Alt MSL</span><span class="val" id="t-alt-msl">&mdash;</span></div>
                <div class="row"><span class="lbl">Alt REL</span><span class="val" id="t-alt-rel">&mdash;</span></div>
                <div class="row"><span class="lbl">Fix</span><span class="val" id="t-fix">&mdash;</span></div>
                <div class="row"><span class="lbl">Sats</span><span class="val" id="t-sats">&mdash;</span></div>
                <div class="row"><span class="lbl">HDOP</span><span class="val" id="t-hdop">&mdash;</span></div>
              </div>
              <div class="tcard">
                <h3>Flight</h3>
                <div class="row"><span class="lbl">Mode</span><span id="t-mode"><span class="mode-badge">&mdash;</span></span></div>
                <div class="row"><span class="lbl">Armed</span><span id="t-armed"><span class="armed-badge">&mdash;</span></span></div>
                <div class="row"><span class="lbl">GndSpeed</span><span class="val" id="t-speed">&mdash;</span></div>
                <div class="row"><span class="lbl">AirSpeed</span><span class="val" id="t-airspeed">&mdash;</span></div>
                <div class="row"><span class="lbl">Heading</span><span class="val" id="t-heading">&mdash;</span></div>
                <div class="row"><span class="lbl">Climb</span><span class="val" id="t-climb">&mdash;</span></div>
                <div class="row"><span class="lbl">Throttle</span><span class="val" id="t-throttle">&mdash;</span></div>
              </div>
              <div class="tcard">
                <h3>Battery</h3>
                <div class="row"><span class="lbl">Voltage</span><span class="val" id="t-bat-v">&mdash;</span></div>
                <div class="row"><span class="lbl">Current</span><span class="val" id="t-bat-a">&mdash;</span></div>
                <div class="row"><span class="lbl">Remaining</span><span class="val" id="t-bat-pct">&mdash;</span></div>
                <div class="bat-bar-wrap"><div class="bat-bar high" id="t-bat-bar" style="width:0%"></div></div>
              </div>
              <div class="tcard">
                <h3>Attitude</h3>
                <div class="row"><span class="lbl">Roll</span><span class="val" id="t-roll">&mdash;</span></div>
                <div class="row"><span class="lbl">Pitch</span><span class="val" id="t-pitch">&mdash;</span></div>
                <div class="row"><span class="lbl">Yaw</span><span class="val" id="t-yaw">&mdash;</span></div>
              </div>
            </div>
          </div>

          <!-- ── Tab 3: LoRa ── -->
          <div id="tab-lora" class="tab-panel" role="tabpanel">
            <section class="card">
              <header>
                <h2>LoRa Link</h2>
                <span id="lora-conn-label" class="status-label">Disconnected</span>
              </header>
              <div class="lora-stats" id="lora-stats"></div>
              <div class="lora-controls">
                <input id="lora-text" type="text" placeholder="Message..." />
                <button id="lora-send-btn" type="button">Send</button>
              </div>
            </section>
            <section class="card flex-1">
              <header><h2>Message Log</h2><span id="lora-clear-btn" class="link-btn">Clear</span></header>
              <div id="lora-log" class="lora-log"></div>
            </section>
          </div>

          <!-- ── Tab 4: DB (Recordings & Detections) ── -->
          <div id="tab-db" class="tab-panel" role="tabpanel">

            <!-- Shared filter bar -->
            <div class="filter-bar">
              <select id="db-sort">
                <option value="date-desc">Newest first</option>
                <option value="date-asc">Oldest first</option>
                <option value="det-desc">Most detections</option>
              </select>
              <input id="sess-class-filter" type="text" placeholder="Filter by class..." />
              <span id="db-refresh-btn" class="link-btn">Refresh</span>
            </div>

            <!-- Recordings -->
            <section class="card">
              <header>
                <h2>Recordings</h2>
                <div class="header-actions">
                  <span class="rec-indicator"><span class="rec-dot" id="rec-dot"></span><span id="rec-status">Idle</span></span>
                  <button id="rec-start-btn" class="sm accent">REC</button>
                  <button id="rec-stop-btn" class="sm danger" disabled>STOP</button>
                </div>
              </header>
              <div id="rec-list" class="rec-list">Loading...</div>
            </section>

            <!-- Detections -->
            <section class="card">
              <header>
                <h2>Detection Sessions</h2>
              </header>
              <div id="sess-list" class="sess-list">Loading...</div>
            </section>
          </div>

        </div>
      </aside>

    </main>

    <details>
      <summary>WebSocket Logs</summary>
      <h3 class="ws-section-title">Detection WS</h3>
      <pre class="log" id="ws-det-log"></pre>
      <h3 class="ws-section-title">MAVLink WS</h3>
      <pre class="log" id="ws-mav-log"></pre>
      <h3 class="ws-section-title">LoRa WS</h3>
      <pre class="log" id="ws-lora-log"></pre>
    </details>

    <div class="footer">DC-Detector v0.2 &mdash; Raspberry Pi 5</div>
  </div>

  <!-- ====== Modal for detection preview ====== -->
  <div id="det-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true">
      <button class="modal-close" id="modal-close" aria-label="Close">&times;</button>
      <div class="modal-body">
        <div class="modal-media">
          <img id="modal-image" alt="Detection" />
        </div>
        <div class="modal-meta">
          <h3>Detection Details</h3>
          <dl id="modal-dl"></dl>
        </div>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
